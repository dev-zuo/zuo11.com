
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="uni_request.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="uni.request封装,uni axios分装,在uni-app中为了抹平各平台的差异，官方提供了uni.request方法，和微信小程序的请求方法类似，一般这类请求是比较通用的，如果直接使用会有大量的重复代码，于是做了简单的封装，来看看代码">
        <meta name="keywords" content="uni.request封装,uni axios分装">

        <title>uni.request封装为类似axios的请求对象 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
        <script data-ad-client="ca-pub-9527676606416641" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#移动端混合开发" class="hidden">移动端混合开发</a>
          </div>
          <div>
            
          <a href="https://www.yuque.com/guoqzuo" target="_black" class="hidden">语雀</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            <h1 id="unirequest封装为类似axios的请求对象">uni.request封装为类似axios的请求对象</h1>
            
    <div class="article-top">
      <div class="flex">
        这篇文章发布于 2020/07/26，归类于 <a href="/blog/category.html#移动端混合开发" class="hidden">移动端混合开发</a>
        <!-- ，阅读 11 次，今日 1 次 <div class="top-comment">4 条评论</div> -->
        <div id="readAndComment" class="flex"></div>
      </div> 
      <div class="flex keywords" style="flex-wrap: nowrap;">
        <div style="flex-shrink:0; align-self: flex-start;">标签：</div>
        <div class="flex" style="flex-wrap: wrap;"><span>uni.request封装</span>，<span>uni axios分装</span></div>
      </div>
    </div>
    
  
            
<p>在uni-app中为了抹平各平台的差异，官方提供了uni.request方法，和微信小程序的请求方法类似，一般这类请求是比较通用的，如果直接使用会有大量的重复代码，于是做了简单的封装，来看看代码</p>
<p>axios.js</p>
<pre><code class="language-js">/**
 * @description 将uni.request封装成简单的aixos
 * @author guoqzuo
 * @example
 * axios.create(config) 根据配置，创建axios实例
 * axios.get(url[, config]) get请求
 * axios.post(url[, data[, config]]) post请求
 * config支持配置项
 * baseURL: &quot;https://some-domain.com/api/&quot;, // baseURL
 * timeout: 1000, // 超时时间
 * headers: { &quot;X-Custom-Header&quot;: &quot;foobar&quot; }, // 请求头
 * method: &#39;&#39; // 请求方法
 * url: &#39;&#39;, // 请求url
 * data: &#39;&#39; // post 请求的data
 * toastErrorMsg 是否用toast显示错误信息，默认为是
 * showLoading  是否显示loading
 * reTry 是否重试，默认为否，待实现
 * params: &#39;&#39; // url后面的查询参数，待实现
 */

import Utils from &#39;@/utils/utils.js&#39;
class Axios {
  constructor() {
    this.config = {}
  }

  // 全局配置，返回一个axios实例
  create(config = {}) {
    Object.assign(this.config, config)
    return this
  }

  get(url = &#39;&#39;, data = {}, config = {}) {
    // 暂不支持params
    config = { ...this.config, ...config, url, method: &#39;GET&#39;, data }
    return this._request(config)
  }

  post(url = &#39;&#39;, data = {}, config = {}) {
    config = { ...this.config, ...config, url, method: &#39;POST&#39;, data }
    return this._request(config)
  }

  // uni.request 封装
  _request(config) {
    return new Promise(async (resolve, reject) =&gt; {
      const {
        baseURL,
        timeout,
        headers,
        method,
        url,
        data = {},
        toastErrorMsg,
        showLoading,
        successCode = 0
      } = config
      showLoading &amp;&amp;
        uni.showLoading({
          mask: true
        })
      const token = uni.getStorageSync(&#39;shopUserToken&#39;);
      token &amp;&amp; (data.token = token)
      const [error, res] = await uni.request({
        data,
        method,
        header: headers,
        timeout,
        url: baseURL + url
      })

      // 请求完成后做 complete 该执行的内容
      showLoading &amp;&amp; uni.hideLoading()

      // 判断请求是否成功，这里很奇怪，官方把error直接返回了，类似于node的callback
      if (error) {
        this._showToast(toastErrorMsg, error.errMsg)
        reject(error.errMsg)
        return
      }

      // statusCode === 200
      const { statusCode, header, data: resData } = res
      if (!resData || typeof resData !== &#39;object&#39;) {
        const msg = &#39;接口异常，data数据出错&#39;
        this._showToast(toastErrorMsg, msg)
        reject(msg)
        return
      }

      const { code = &#39;&#39;, msg = &#39;&#39; } = resData
      // 请求成功，且状态码ok
      if (Number.parseInt(code) === successCode) {
        resolve(resData.data)
      } else {
        // msg: &quot;登录失效，请重新登录&quot; code: -400
        if (`${code}` === &#39;-400&#39;) {
          uni.redirectTo({
            url: &#39;/pages/login/login&#39;
          })
          setTimeout(() =&gt; {
            this._showToast(toastErrorMsg, msg)
          }, 1000)
        } else {
          this._showToast(toastErrorMsg, msg)
        }
        reject(msg)
      }
    })
  }

  // 根据toastErrorMsg判断是否需要显示错误信息
  _showToast(toastErrorMsg, msg) {
    toastErrorMsg &amp;&amp;
      uni.showToast({
        title: msg,
        icon: &#39;none&#39;,
        image: &#39;&#39;,
        duration: 1500,
        mask: false
      })
  }
}

const axios = new Axios()
export default axios
</code></pre>
<p>配置axios service.js</p>
<pre><code class="language-js">// service.js
import axios from &#39;./utils/axios&#39;

const axiosInstance = axios.create({
  baseURL: &quot;/index.php&quot;,
  successCode: 0, // 后端自己定义的成功或的错误码
  toastErrorMsg: true, // 是否用toast显示错误信息，默认为是
  showLoading: true  // 是否显示loading
});

export default axiosInstance</code></pre>
<p>模块 modules/user.js</p>
<pre><code class="language-js">import createServiceFromConfig from &#39;../utils/createServiceFromConfig&#39;

// 用户模块service
export default createServiceFromConfig([
  [&#39;login&#39;, &#39;/user/login&#39;, &#39;post&#39;] // 登录
])</code></pre>
<p>根据配置生成接口服务 createServiceFromConfig.js</p>
<pre><code class="language-js">import service from &#39;../service&#39;

function createServiceFromConfig(configList) {
  let serviceObj = {}
  configList.forEach(item =&gt; {
    let [apiName, url, method = &#39;get&#39;] = item
    serviceObj[apiName] = (payload = {}, config = {}) =&gt; {
      let url = item[1] // url 是第二位
      // uni.request 设置data会直接附加到get请求末尾，所以不用转换
      // let params = method === &#39;get&#39; ? [config] : [payload, config]
      let params = [payload, config]
      return service[method](url, ...params); // 等价于 return axios.get(..)
    }
  })
  return serviceObj
}

export default createServiceFromConfig</code></pre>
<p>调用接口</p>
<pre><code class="language-js">import userService from &quot;@/service/modules/user&quot;;
async login() {
  try {
    let data = await userService.login({
      mobile: &quot;xxx&quot;,
      password: &quot;xxx&quot;
    });
    console.log(data);
  } catch (e) {
    console.error(e);
  }
}</code></pre>

            
            
            <!-- 评论系统占位 -->
            <div id="commentDiv"></div>
          </article>

          <aside>
            <div class="aside-wrap">
              <ins class='adsbygoogle' style='display:block;width:300px;height:250px;' data-ad-client='ca-pub-9527676606416641' data-ad-slot='9476232907' data-ad-format='auto' data-full-width-responsive='true'></ins>
              <div class="top ">
                <ul><li><span class="ul-span" data-id="unirequest封装为类似axios的请求对象" style="padding-left:1em">uni.request封装为类似axios的请求对象<span></li></ul>
              <div>
            </div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2020 zuo11.com. <a href='http://www.beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-178732583-1"></script>
<script>
  // Google AD
  console.log('adsbygoogle', window.adsbygoogle || []);

  (adsbygoogle = window.adsbygoogle || []).push({});

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-178732583-1');
</script>

      </body>
    </html>
  