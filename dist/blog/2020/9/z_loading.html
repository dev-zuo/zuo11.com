
    <!DOCTYPE html>
    <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="z_loading.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="v-loading的实现,怎么通过一个指令自动加载骨架屏,element v-loading在IE下可能会溢出到全屏的问题,element v-loading在IE下可能会关不掉的问题，这里需要用到vue自定义指令，我们先写个v-zloading来实现loading，在loading过程中加骨架屏，由于是全局自定义指令，所以在main.js里写">
        <meta name="keywords" content="v-loading的实现,怎么通过一个指令自动加载骨架屏,element v-loading在IE下可能会溢出到全屏的问题,element v-loading在IE下可能会关不掉的问题">

        <title>v-loading指令的实现，怎么通过一个指令自动加骨架屏 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
        
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#vue" class="hidden">Vue</a>
          </div>
          <div>
            
          <a href="http://fe.zuo11.com" target="_black" class="hidden">我的笔记</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            <h1 id="v-loading指令的实现，怎么通过一个指令自动加骨架屏">v-loading指令的实现，怎么通过一个指令自动加骨架屏</h1>
            
    <div class="article-top">
      <div class="flex">
        这篇文章发布于 2020/09/07，归类于 <a href="/blog/category.html#vue" class="hidden">Vue</a>
        <!-- ，阅读 11 次，今日 1 次 <div class="top-comment">4 条评论</div> -->
        <div id="readAndComment" class="flex"></div>
      </div> 
      <div class="flex keywords" style="flex-wrap: nowrap;">
        <div style="flex-shrink:0; align-self: flex-start;">标签：</div>
        <div class="flex" style="flex-wrap: wrap;"><span>v-loading的实现</span>，<span>怎么通过一个指令自动加载骨架屏</span>，<span>element v-loading在IE下可能会溢出到全屏的问题</span>，<span>element v-loading在IE下可能会关不掉的问题</span></div>
      </div>
    </div>
    
  
            
<p>这里需要用到vue自定义指令，我们先写个v-zloading来实现loading，在loading过程中加骨架屏</p>
<pre><code class="language-html">&lt;div v-zloading=&quot;loading&quot; class=&quot;div&quot;&gt;
  测试
&lt;/div&gt;</code></pre>
<p><img src="../../../images/blog/vue/v_loading.gif" alt="v_loading.gif"></p>
<p>由于是全局自定义指令，所以在main.js里写</p>
<pre><code class="language-js">// 挂载dom
function mountDom(el) {
  el.style.position = &quot;relative&quot;;

  let div = document.createElement(&quot;div&quot;);
  div.style.position = &quot;absolute&quot;;
  div.style.top = &quot;0&quot;;
  div.style.left = &quot;0&quot;;
  div.style.right = &quot;0&quot;;
  div.style.bottom = &quot;0&quot;;
  div.style.backgroundColor = &quot;white&quot;;
  div.classList.add(&quot;zloading&quot;);

  let htmlStr = `
    &lt;div style=&quot;positon:absolute;top:0;left:0;z-index:999;width: 100%;margin: 10 auto;&quot;&gt;
      &lt;div class=&quot;fast-loading&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;fast-loading w40&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;fast-loading w80&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
  `;
  div.innerHTML = htmlStr;
  el.appendChild(div);
}

Vue.directive(&quot;zloading&quot;, {
  bind: (el, binding) =&gt; {
    // console.log(&quot;v-zloading bind&quot;);
    // console.log(binding, vnode);
    if (binding.value) {
      mountDom(el);
    }
  },
  update: (el, binding) =&gt; {
    // console.log(&quot;v-zloading update&quot;);
    // console.log(el, binding, vnode);
    let zloadingDom = el.querySelector(&quot;.zloading&quot;);
    // console.log(&quot;zloading dom&quot;, zloadingDom);
    if (zloadingDom) {
      zloadingDom.style.display = binding.value ? &quot;block&quot; : &quot;none&quot;;
    } else {
      binding.value &amp;&amp; mountDom(el);
    }
  }
});</code></pre>
<p>骨架屏的样式common.css，然后在App.vue里引入</p>
<pre><code class="language-css">.fast-loading {
    height: 20px;
    margin: 10px 0;
    width: 200px;
    background-color: rgb(245, 245, 245);
    background-image: repeating-linear-gradient(90deg, #eee, #f5f5f5 100%);

    animation-name: fastLoading;
    animation-timing-function: linear;
    animation-duration: 1s;
    animation-iteration-count: infinite;
}
@keyframes fastLoading {
    from {
    background-position: 0 0;
    }
    to {
    background-position: 100px 0;
    }
}

.w100 { width: 100% }
.w80 { width: 80% }
.w60 { width: 60% }
.w40 { width: 50% }
.w30 { width: 30% }</code></pre>
<p>这样就模拟实现了一个v-loading, 完整demo参见<a href="https://github.com/zuoxiaobai/fedemo/blob/master/src/vuecli-demo/src/views/vloading/index.vue">v-zloading 实现 | github</a>  注意，指令的实现是放在main.js里面的</p>
<h2 id="v-loading源码">v-loading源码</h2>
<p>我们自己简单实现v-loaidng的功能后，再来看看v-loading的源码</p>
<pre><code class="language-js">// 截取至element v-loading部分源码 
// https://github.com/ElemeFE/element/blob/dev/packages/loading/src/directive.js
Vue.directive(&#39;loading&#39;, {
    bind: function(el, binding, vnode) {
      //....
      const mask = new Mask({
        el: document.createElement(&#39;div&#39;),
        data: {
          text: vm &amp;&amp; vm[textExr] || textExr,
          spinner: vm &amp;&amp; vm[spinnerExr] || spinnerExr,
          background: vm &amp;&amp; vm[backgroundExr] || backgroundExr,
          customClass: vm &amp;&amp; vm[customClassExr] || customClassExr,
          fullscreen: !!binding.modifiers.fullscreen
        }
      });
      el.instance = mask;
      el.mask = mask.$el;
      el.maskStyle = {};

      // 如果v-loading设置的值为true，挂载maskdom(toggleLoading方法)
      binding.value &amp;&amp; toggleLoading(el, binding);
    },

    update: function(el, binding) {
      el.instance.setText(el.getAttribute(&#39;element-loading-text&#39;));
      if (binding.oldValue !== binding.value) {
        toggleLoading(el, binding);
      }
    },

    unbind: function(el, binding) {
      if (el.domInserted) {
        el.mask &amp;&amp;
        el.mask.parentNode &amp;&amp;
        el.mask.parentNode.removeChild(el.mask);
        toggleLoading(el, { value: false, modifiers: binding.modifiers });
      }
      el.instance &amp;&amp; el.instance.$destroy();
    }
  });</code></pre>
<p>回过头来看看之前element UI在IE下可能会出现的两个bug</p>
<h2 id="element-v-loading在ie下可能会溢出到全屏的问题">element v-loading在IE下可能会溢出到全屏的问题</h2>
<p>我的理解是，我觉得主要的核心在于在v-loading作用的元素上添加position:relative没有成功</p>
<pre><code class="language-js">// ...
if (el.originalPosition !== &#39;absolute&#39; &amp;&amp; el.originalPosition !== &#39;fixed&#39;) {
  addClass(parent, &#39;el-loading-parent--relative&#39;);
}
// ...</code></pre>
<h2 id="element-v-loading在ie下可能会关不掉的问题">element v-loading在IE下可能会关不掉的问题</h2>
<p>我的理解是，当binding.value有值时，它是在Vue.nextTick下次渲染周期才挂载loading的dom，如果设置true,false间隔非常快，还没在下个渲染周期，那么其实loading已经是false了，但它才开始挂载，导致关闭不了</p>
<pre><code class="language-js">// ...
if (binding.value) {
    Vue.nextTick(() =&gt; {
      if (binding.modifiers.fullscreen) {
        el.originalPosition = getStyle(document.body, &#39;position&#39;);
        el.originalOverflow = getStyle(document.body, &#39;overflow&#39;);
        el.maskStyle.zIndex = PopupManager.nextZIndex();

        addClass(el.mask, &#39;is-fullscreen&#39;);
        insertDom(document.body, el, binding);
      } else {
        removeClass(el.mask, &#39;is-fullscreen&#39;);
// ...</code></pre>
<p>后面有机会在 node_modules 下修改源码加上console，然后在IE下调试看看，这个是目前来说最好的方法。</p>
<p>参考：</p>
<ul>
<li><a href="https://cn.vuejs.org/v2/guide/custom-directive.html">vue自定义指令 | Vue.js</a></li>
<li><a href="https://www.yuque.com/guoqzuo/yyxr05/hp742n">vue自定义指令笔记 | 语雀</a></li>
</ul>

            
            <ins class='adsbygoogle' style='display:block;margin-top:1em;margin-bottom:0' data-ad-format='fluid' data-ad-layout-key='-gw-3+1f-3d+2z' data-ad-client='ca-pub-9527676606416641' data-ad-slot='8870245163'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            <!-- 评论系统占位 -->
            <div id="commentDiv"></div>
          </article>

          <aside>
            <div class="aside-wrap">
              <div class="top ">
                <ul><li><span class="ul-span" data-id="v-loading指令的实现，怎么通过一个指令自动加骨架屏" style="padding-left:1em">v-loading指令的实现，怎么通过一个指令自动加骨架屏<span></li><ul><li><span class="ul-span" data-id="v-loading源码" style="padding-left:2em">v-loading源码<span></li></ul><ul><li><span class="ul-span" data-id="element-v-loading在ie下可能会溢出到全屏的问题" style="padding-left:2em">element v-loading在IE下可能会溢出到全屏的问题<span></li></ul><ul><li><span class="ul-span" data-id="element-v-loading在ie下可能会关不掉的问题" style="padding-left:2em">element v-loading在IE下可能会关不掉的问题<span></li></ul></ul>
              </div>
              <ins class='adsbygoogle' style='display:block;width:300px;height:250px;' data-ad-client='ca-pub-9527676606416641' data-ad-slot='9476232907'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2020 zuo11.com. <a href='http://beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-178732583-1"></script> -->
<script>
  // window.dataLayer = window.dataLayer || [];
  // function gtag(){dataLayer.push(arguments);}
  // gtag('js', new Date());
  // gtag('config', 'UA-178732583-1');

  window.onload = function() {
    setTimeout(function() {
      let script = document.createElement("script");
      script.setAttribute("data-ad-client", "ca-pub-9527676606416641");
      script.setAttribute("async", "");
      script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
      document.body.appendChild(script);
    }, 200);
  }
</script>

      </body>
    </html>
  