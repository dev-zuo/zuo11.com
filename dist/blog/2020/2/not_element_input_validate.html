
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="not_element_input_validate.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="今天写表单校验规则，有个 el-form-item 里使用了富文本编辑器，发现校验规则校验这个值会有异常: 1. 当 change 或 blur 时，根本没有触发校验(提示错误) 2. 提交表单时，当该字段校验失败会提示错误，但该字段符合要求时，validate的回调一直没触发，导致无法进行校验成功之后的下一步操作，将富文本编辑器换成 el-input 正常，换成普通的 input 也会异常，感觉一头雾水。">
        <meta name="keywords" content="element表单校验时如果非element组件会触发布料校验,富文本编辑器在element form中校验回调函数不触发的问题">

        <title>el-form-item里非elment输入组件时，校验回调函数不触发的问题 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#vue" class="hidden">vue</a>
          </div>
          <div>
            
          <a href="https://www.yuque.com/guoqzuo" target="_black" class="hidden">语雀</a>
        
          <a href="https://space.bilibili.com/486840111" target="_black" class="hidden">B站</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            
    <div class="article-top">
      <div>2020/02/27</div> 
      <div class="article-top-right">Author: guoqzuo</div>
    </div>
  
            <h1 id="el-form-item里非elment输入组件时，校验回调函数不触发的问题">el-form-item里非elment输入组件时，校验回调函数不触发的问题</h1>
<p>今天写表单校验规则，有个 el-form-item 里使用了富文本编辑器，发现校验规则校验这个值会有异常：</p>
<ol>
<li>当 change 或 blur 时，根本没有触发校验(提示错误)</li>
<li>提交表单时，当该字段校验失败会提示错误，但该字段符合要求时，validate的回调一直没触发，导致无法进行校验成功之后的下一步操作</li>
</ol>
<p>将富文本编辑器换成 el-input 正常，换成普通的 input 也会异常，感觉一头雾水。</p>
<p>使用 this.$refs.ruleForm.validateField(&#39;xxx&#39;) 单读校验也不行，这个应该是element表单输入组件特有的</p>
<p>于是粗略看了下源码，发现错误信息在form-item(也就是el-form-item)组件里处理，当el-select或el-input值改变时会将事件传递给form-item</p>
<p>两个不同的组件，一个组件里怎么捕获到另一个组件的事件呢，在element内部使用了发布订阅设计模式来处理：</p>
<ol>
<li>在form-item里订阅事件</li>
<li>当el-input或el-select等elemnt表单输入组件的值改变时，发布事件</li>
</ol>
<p>来看源码</p>
<pre><code class="language-js">// 在 form-item 里订阅事件
// https://github.com/ElemeFE/element/blob/1.x/packages/form/src/form-item.vue
if (rules.length || this._props.hasOwnProperty(&#39;required&#39;)) {
  this.$on(&#39;el.form.blur&#39;, this.onFieldBlur);
  // 订阅了el.form.change事件
  this.$on(&#39;el.form.change&#39;, this.onFieldChange);
}

// 当 el-input 值改变时，发布事件
// https://github.com/ElemeFE/element/blob/1.x/packages/input/src/input.vue
// el-input
setCurrentValue(value) {
  if (value === this.currentValue) return;
  this.$nextTick(_ =&gt; {
    this.resizeTextarea();
  });
  this.currentValue = value;
  if (this.validateEvent) {
    // 发布el.form.change事件
    this.dispatch(&#39;ElFormItem&#39;, &#39;el.form.change&#39;, [value]);
  }
}

// el-select
// https://github.com/ElemeFE/element/blob/1.x/packages/select/src/select.vue
value(val) {
  if (this.multiple) {
    this.resetInputHeight();
    if (val.length &gt; 0 || (this.$refs.input &amp;&amp; this.query !== &#39;&#39;)) {
      this.currentPlaceholder = &#39;&#39;;
    } else {
      this.currentPlaceholder = this.cachedPlaceHolder;
    }
  }
  this.setSelected();
  if (this.filterable &amp;&amp; !this.multiple) {
    this.inputLength = 20;
  }
  this.$emit(&#39;change&#39;, val);
  this.dispatch(&#39;ElFormItem&#39;, &#39;el.form.change&#39;, val);
}</code></pre>
<p>所以，如果表单里使用了非element输入组件，比如普通的input，当值改变或输入框失去焦点时，没有发布对应的事件，那么form-item组件就不会触发校验</p>
<p>怎么来处理呢？这里暂时采用自定义方法来处理：</p>
<ol>
<li>从rules移除对应的字段 required，至于label前面的红星，直接在el-form-item__label类上加一个before属性来设置</li>
<li>对于行内显示错误信息，可以在el-form-item__label的after里显示错误信息，通过一个父类的error-class来控制隐藏显示</li>
<li>单独写校验逻辑，如果校验失败加上一个error-class，如果想做的更逼真一点，在错误时给输入组件加一个红色的border</li>
</ol>

          </article>
          <aside>
            <div>
              <ul><li><span class="ul-span" data-id="el-form-item里非elment输入组件时，校验回调函数不触发的问题" style="padding-left:1em">el-form-item里非elment输入组件时，校验回调函数不触发的问题<span></li></ul>
            <div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2020 zuo11.com. <a href='http://www.beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
      </body>
    </html>
  