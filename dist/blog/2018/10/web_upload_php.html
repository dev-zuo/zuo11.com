
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="web_upload_php.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="开始做图片上传，发现之前的处理方式基本忘光了。看了下原来的源码才有了解，还是要总结经验，不然忘的太快。之前是用jQuery来处理的，也是ajax方式。现在改为用原生的ajax来处理，不依赖jQuery，整体还算是比较简单的。">
        <meta name="keywords" content="原生ajax上传图片，php后台处理图片上传">

        <title>原生ajax上传图片，php后台处理总结 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
        <script data-ad-client="ca-pub-9527676606416641" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#后端数据库等" class="hidden">后端数据库等</a>
          </div>
          <div>
            
          <a href="https://www.yuque.com/guoqzuo" target="_black" class="hidden">语雀</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            <h1 id="原生ajax上传图片，php后台处理总结">原生ajax上传图片，php后台处理总结</h1>
            
    <div class="article-top">
      <div class="flex">
        这篇文章发布于 2018/10/03，归类于 <a href="/blog/category.html#后端数据库等" class="hidden">后端数据库等</a>
        <!-- ，阅读 11 次，今日 1 次 <div class="top-comment">4 条评论</div> -->
        <div id="readAndComment" class="flex"></div>
      </div> 
      <div class="flex keywords" style="flex-wrap: nowrap;">
        <div style="flex-shrink:0; align-self: flex-start;">标签：</div>
        <div class="flex" style="flex-wrap: wrap;"><span>原生ajax上传图片，php后台处理图片上传</span></div>
      </div>
    </div>
    <ins class='adsbygoogle' style='display:block;margin-top:1em;margin-bottom:0' data-ad-format='fluid' data-ad-layout-key='-gw-3+1f-3d+2z' data-ad-client='ca-pub-9527676606416641' data-ad-slot='8870245163'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  
            
<blockquote>
<p>开始做图片上传，发现之前的处理方式基本忘光了。看了下原来的源码才有了解，还是要总结经验，不然忘的太快。之前是用jQuery来处理的，也是ajax方式。现在改为用原生的ajax来处理，不依赖jQuery，整体还算是比较简单的。</p>
</blockquote>
<h2 id="前端表单提交">前端表单提交</h2>
<p>两种方式，一种是有form元素的，一种是没form元素的</p>
<pre><code class="language-html">&lt;!-- 有form的方式 --&gt;
&lt;form name=&quot;form&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;editorImg&quot;  onchange=&quot;uploadImg(this)&quot; accept=&quot;image/*&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;testttt&quot;&gt;
&lt;/form&gt;

&lt;!-- 没form的方式 --&gt;
&lt;input type=&quot;file&quot; name=&quot;editorImg&quot;  onchange=&quot;uploadImg(this)&quot; accept=&quot;image/*&quot;&gt;

&lt;script&gt;
     // 当input元素触发onchange事件，如果选择了图片，上传图片
     function uploadImg(obj) {
        // 获取文件对象，信息包括: 文件名、文件大小、文件类型
    console.log(obj.files[0]);
    if (!obj.files[0]) {
            console.log(&quot;打开的文件，点击了取消.&quot;);
            return;
        }

        // 传值 - 有form的情况
        // var form = document.getElementsByTagName(&#39;form&#39;)[0];
        // var formData = new FormData(form);

        // 传值 - 没有form的情况
    var formData = new FormData();
    formData.append(&quot;id&quot;, &quot;123&quot;);
    formData.append(&quot;name&quot;, &quot;test&quot;);
    formData.append(&quot;editorImg&quot;, obj.files[0]);
    console.log(formData);

         // ajax上传文件，及表单数据
    var xhr = new XMLHttpRequest();
    xhr.open(&quot;post&quot;, &quot;./server/post_info.php&quot;, false);
        // 这里不用设置请求头等，默认为multipart/form-data; 
    xhr.send(formData);

    var status = xhr.status;
    if ((status &gt;= 200 &amp;&amp; status &lt; 300) || status == 304) {
        // xhr.responseText;
        var res = JSON.parse(xhr.responseText);  
            // 上传图片成功后，进行后续逻辑，省略了错误处理等          
        var result = document.execCommand(&#39;insertImage&#39;, false, res.filePath);
            if (!result) {
        // 获得焦点，防止可编辑div无焦点时，无效的问题
        document.getElementsByClassName(&quot;editor&quot;)[0].focus();
        document.execCommand(&#39;insertImage&#39;, false, res.filePath);
        }
    } else {
        alert(xhr.status);
    }
}
&lt;/script&gt;</code></pre>
<h2 id="后端php处理">后端php处理</h2>
<p>./server/post_info.php 处理逻辑如下</p>
<pre><code class="language-php">&lt;?php
header(&quot;Content-type:application/json;charset=utf-8&quot;);
# 添加响应头，防止中文乱码

$result = move_uploaded_file($_FILES[&#39;editorImg&#39;][&#39;tmp_name&#39;],&quot;../uploads/&quot;.$_FILES[&quot;editorImg&quot;][&quot;name&quot;]);
// echo &quot;result&quot;.$k.&quot;result&quot;;
if ($result) { 
    echo json_encode(array(
        &quot;error_code&quot; =&gt; 0,
        &quot;error_msg&quot; =&gt; &quot;上传成功&quot;,
        &quot;filePath&quot; =&gt; &quot;./uploads/&quot;.$_FILES[&quot;editorImg&quot;][&quot;name&quot;]
    ));
} else {
    echo json_encode(array(
        &quot;error_code&quot; =&gt; -1,
        &quot;error_msg&quot; =&gt; &quot;上传失败&quot;,
        &quot;filePath&quot; =&gt; &quot;./uploads/&quot;.$_FILES[&quot;editorImg&quot;][&quot;name&quot;]
    ));
}</code></pre>
<h2 id="遇到的问题及处理过程">遇到的问题及处理过程</h2>
<p>乍一看，so easy，但功能跑通纠结了好一会儿</p>
<h3 id="问题一-后端接收不到传值，乱码问题">问题一 后端接收不到传值，乱码问题</h3>
<p>以下三种都试了，除了不设置直接用系统的，以下三个请求头都会导致后台php获取文件数据异常</p>
<pre><code class="language-js">xhr.setRequestHeader(&quot;Content-type&quot;,&quot;text/plain;charset=UTF-8&quot;);
xhr.setRequestHeader(&quot;Content-type&quot;,&quot;multipart/form-data;charset=UTF-8&quot;);
xhr.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;);</code></pre>
<p>乱码的情况，添加了请求头没反应, header(&quot;Content-type:application/json;charset=utf-8&quot;);
后来又突然好了，可能是我直接在apache上面跑的，有缓存。</p>
<h3 id="问题二-文件保存失败-无任何错误提示">问题二 文件保存失败, 无任何错误提示</h3>
<p>最开始move_uploaded_file函数执行一点反应的没有，看了文档会返回 true or false，后来我测试，每次返回的是空字符串，也就是 &quot;&quot;，而且还不报任何错误。于是把前段时间弄文件上传的demo拿出来跑了跑居然是可以的，对比了下，发现应该是目录权限的问题，upload默认权限为 744(drwxr--r--)，一般用户没有写的权限，于是改成了777(drwxrwxrwx)的权限，然后就成功了。发现move_uploaded_file函数执行成功返回1。也就是这个函数返回&quot;&quot;或&quot;1&quot;，如果说返回 true / false 也行，但有误导的意思。定位不到错误时，让人怀疑人生。</p>
<pre><code class="language-shell">chmod 777 upload</code></pre>
<p>然后我就郁闷了，怎么让move_uploaded_file这个函数在遇到问题时报错。由于没有用任何框架，直接将php放到apache的根目录直接跑项目，重新看了下php错误处理，搜了对应的内容。发现php默认提示错误居然是关闭的。举个最简单的例子，下面是页面1.php的代码，直接运行会显示空白页，什么都没有，但test是未定义的，且x=4明显语法错误都没提示。</p>
<pre><code class="language-php">&lt;?php
x=4;
echo $test;
?&gt;</code></pre>
<p>有两种方法可以让系统提示错误</p>
<ul>
<li>自己捕获错误，加入如下代码，出现上面test未定义的情况，会提示错误，而非空白页，但x=4的语法错误还是不会提示。<pre><code class="language-js">&lt;?php
function customError($errno, $errstr)
{
  echo &quot;&lt;b&gt;Error:&lt;/b&gt; [$errno] $errstr&lt;br&gt;&quot;;
  echo &quot;脚本结束&quot;;
  die();
}
set_error_handler(&quot;customError&quot;);
x=4;
echo $test;
?&gt;</code></pre>
</li>
<li>将系统的错误提示打开，都会有提示
php.ini配置文件里面 display_errors = Off 默认设置是关闭的，改为On后重启apache服务即可生效。<pre><code>display_errors = On</code></pre></li>
</ul>

            
            <ins class='adsbygoogle' style='display:block;text-align:center;' data-ad-layout='in-article' data-ad-format='fluid' data-ad-client='ca-pub-9527676606416641' data-ad-slot='5125924359'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            <!-- 评论系统占位 -->
            <div id="commentDiv"></div>
          </article>

          <aside>
            <div class="aside-wrap">
              <ins class='adsbygoogle' style='display:inline-block;width:300px;height:250px;' data-ad-client='ca-pub-9527676606416641' data-ad-slot='9476232907'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
              <div class="top ">
                <ul><li><span class="ul-span" data-id="原生ajax上传图片，php后台处理总结" style="padding-left:1em">原生ajax上传图片，php后台处理总结<span></li><ul><li><span class="ul-span" data-id="前端表单提交" style="padding-left:2em">前端表单提交<span></li></ul><ul><li><span class="ul-span" data-id="后端php处理" style="padding-left:2em">后端php处理<span></li></ul><ul><li><span class="ul-span" data-id="遇到的问题及处理过程" style="padding-left:2em">遇到的问题及处理过程<span></li><ul><li><span class="ul-span" data-id="问题一-后端接收不到传值，乱码问题" style="padding-left:3em">问题一 后端接收不到传值，乱码问题<span></li></ul><ul><li><span class="ul-span" data-id="问题二-文件保存失败-无任何错误提示" style="padding-left:3em">问题二 文件保存失败, 无任何错误提示<span></li></ul></ul></ul>
              <div>
            </div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2020 zuo11.com. <a href='http://www.beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-178732583-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-178732583-1');
</script>

      </body>
    </html>
  