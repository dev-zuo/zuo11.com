
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="web_php_mail.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="php发送邮件遇到的坑处理">
        <meta name="keywords" content="php发送邮件,php发送邮件乱码,php 发邮件,php使用qq邮箱发邮件">

        <title>php发送邮件 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#web" class="hidden">web</a>
          </div>
          <div>
            
          <a href="https://www.yuque.com/guoqzuo" target="_black" class="hidden">语雀</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            
    <div class="article-top">
      <div>2018/10/05</div> 
      <div class="article-top-right">Author: guoqzuo</div>
    </div>
  
            <h1 id="php发送邮件">php发送邮件</h1>
<blockquote>
<p>邮件发送是一个很重要的功能，具体应用包括注册时邮箱验证、评论回复提醒、推送广告、线上异常报告等。一般网上php教程里面邮件发送很简单，一个mail()函数就搞定。但这个方法如果你去试，90%是不成功的。然后就会去搜php怎么发送邮件，搜到的答案基本没有直接使用mail()的，都是使用PHPMailer这个开源库，我一般的思路是在能不使用第三方库的时候尽量不去使用。但后面发现还是要使用这个库。</p>
</blockquote>
<h2 id="php发送邮件的两种方式">php发送邮件的两种方式</h2>
<h3 id="直接使用系统的mail函数需要本地邮件服务器">直接使用系统的mail()函数(需要本地邮件服务器)</h3>
<p>最开始使用这个一直发送不出去，后面就在想如果这个发送成功了，接收到邮件时，来源的邮箱、名称会是什么，貌似根本就没有设置过。</p>
<pre><code class="language-php">try {
    // $email = $un;
    $subject = &quot;[fastds] 评论系统注册链接&quot;.$un;
    $message = &quot;Hi &quot;.$un.&quot;,&lt;br&gt; 你好，欢迎注册fastds评论系统。&lt;br&gt; 请在如下链接完成注册：&lt;br&gt; http://www.jstomp?f=reg&amp;key=sfsdfsdfs2342342sdsfmcvbjjw&lt;br&gt;fastds管理员 guoqzuo&lt;br&gt;i@zuoguoqing.com&quot;;
    $k = mail($un, $subject, $message);
    echo $k;
    // echo &quot;邮件发送成功&quot;;
} catch (Exception $e) {
    echo $e;
}</code></pre>
<p>后面查了下，在php.ini可以设置相关参数，但后来在网上收了下，这个方法需要本地安装有邮件服务器，但这种方式显然是不可行的，自己去配置太麻烦，而且就算发出邮件了，可能会直接被屏蔽。关键是网上的教程不好找，很少有这么做的。我的想法是依托qq邮箱来发送邮件。这样会稳定一点。PHPMailer有很多这种教程，是大家比较推荐的。</p>
<h3 id="使用phpmailer可使用qq发邮件">使用PHPMailer(可使用qq发邮件)</h3>
<p>关于 PHPMailer - A full-featured email creation and transfer class for PHP，在github开源，有1w+ star，应该比较靠谱。现有的百度PHPMailer使用qq发邮件的教程都是比较旧的，直接将项目考到根目录使用，且目录结构、文件名都有变化。最后还是打算以官方文档为主，于是知道了composer，是php里面的一个引入第三方包的工具，会自动安装依赖。类似于node的npm，python的pip。目前来说是比较主流的。</p>
<h4 id="在项目中引入composer">在项目中引入composer</h4>
<ul>
<li>在系统中安装composer</li>
</ul>
<pre><code class="language-js">// 这个命令会将composer.phar文件下载到当前目录
// curl -sS https://getcomposer.org/installer | php
// 将这个文件改名为composer并移动到系统的环境变量里，方便在任何目录使用
// mv composer.phar /usr/local/bin/composer</code></pre>
<ul>
<li>在项目根目录创建 composer.json文件</li>
</ul>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;fastds/fastds&quot;,
    &quot;description&quot;: &quot;comment system&quot;,
    &quot;require&quot;: {
        &quot;phpmailer/phpmailer&quot;: &quot;^6.0&quot;,
        &quot;monolog/monolog&quot;: &quot;^1.23&quot;
    }
}</code></pre>
<ul>
<li>执行composer安装</li>
</ul>
<p>运行下面的命令(二选1)可以安装composer.json里面配置的依赖，如果没有composer.json文件会出错</p>
<pre><code class="language-bash"># 如果下载composer.phar后没改名移动到环境变量
php composer.phar install
# 如果改名了且移动到了全局变量 
composer install

# 也可以在不配置composer.json里面的require，直接运行命令安装最新phpmailer最新版本的
composer require phpmailer/phpmailer</code></pre>
<ul>
<li>安装完成后，会多出一个composer.lock文件和一个vendor目录，vendor目录相当于node的node_modules目录</li>
</ul>
<h4 id="开始发送邮件">开始发送邮件</h4>
<pre><code class="language-php">&lt;?php
// Import PHPMailer classes into the global namespace
// These must be at the top of your script, not inside a function
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

//Load Composer&#39;s autoloader
require &#39;../vendor/autoload.php&#39;;

$mail = new PHPMailer(true);

try {
    //Server settings
    $mail-&gt;SMTPDebug = 1;                     // Enable verbose debug output
    $mail-&gt;isSMTP();                                 // Set mailer to use SMTP
    $mail-&gt;Host = &#39;smtp.qq.com&#39;;            // Specify main and backup SMTP servers
    $mail-&gt;SMTPAuth = true;                   // Enable SMTP authentication
    $mail-&gt;Username = &#39;916707888@qq.com&#39;;  // SMTP username                    
    $mail-&gt;Password = &#39;xxxxxxxxxxxxxxx&#39;;      // SMTP password，这里隐去了密码
    $mail-&gt;SMTPSecure = &#39;ssl&#39;;             // Enable TLS encryption, `ssl` also accepted
    $mail-&gt;Port = 465;                         // TCP port to connect to
    $mail-&gt;CharSet = &quot;UTF-8&quot;;       // 防止发送阿里云邮箱中文乱码

    //Recipients
    $mail-&gt;setFrom(&#39;i@zuoguoqing.com&#39;, &#39;fastds管理员&#39;);  // 设置来源的邮箱/名称
    // $mail-&gt;addAddress(&#39;joe@example.net&#39;, &#39;Joe User&#39;);     // Add a recipient
    $mail-&gt;addAddress($un);               // Name is optional, $un为目标邮件地址
    $mail-&gt;addCC(&#39;i@zuoguoqing.com&#39;);  // add cc，抄送

    //Attachments
    // $mail-&gt;addAttachment(&#39;/var/tmp/file.tar.gz&#39;);         // Add attachments
    // $mail-&gt;addAttachment(&#39;/tmp/image.jpg&#39;, &#39;new.jpg&#39;);    // Optional name

    //Content
    $mail-&gt;isHTML(true);                                  // Set email format to HTML
    $mail-&gt;Subject = &quot;[fastds] 欢迎注册fastds评论系统, 点击链接继续完成注册&quot;;
    $mail-&gt;Body    = &quot;Hi &quot;.$un.&quot;,&lt;br&gt; 你好，欢迎注册fastds评论系统。&lt;br&gt; 请在如下链接完成注册：&lt;br&gt; http://www.jstomp?f=reg&amp;key=sfsdfsdfs2342342sdsfmcvbjjw&lt;br&gt;fastds管理员 guoqzuo&lt;br&gt;i@zuoguoqing.com&quot;;
    $mail-&gt;AltBody = &#39;This is the body in plain text for non-HTML mail clients&#39;;

    $mail-&gt;send();
    echo &#39;Message has been sent&#39;;
} catch (Exception $e) {
    echo &#39;Message could not be sent. Mailer Error: &#39;, $mail-&gt;ErrorInfo;
}
?&gt;</code></pre>
<h2 id="发送邮件遇到的问题">发送邮件遇到的问题</h2>
<ol>
<li>SMTP Error: Could not authenticate 
一开始一直报上面的错误，搜了很多答案。按照网上的方式改了PHPMailer.php里面的一个位置，都没用，还是这个提示<pre><code class="language-php">public function isSMTP()
 {
     $this-&gt;Mailer = &#39;SMTP&#39;;
 }</code></pre>
后面才发现$mail-&gt;Password不是qq邮箱的登录密码，而是在qq邮箱后台服务设置开启pop3/smtp功能时，给出的一个密码。如果忘记了改密码，关闭这个功能，重新开启就可以获得新密码了。改完密码后就发送成功了。</li>
</ol>
<p><img src="../../../images/blog/web/web_php_mail_1.png" alt="image"></p>
<ol start="2">
<li>阿里云收到邮件乱码的问题，直接被认定为垃圾箱</li>
</ol>
<p><img src="../../../images/blog/web/web_php_mail_2.png" alt="image"></p>
<p>直接加一句 $mail-&gt;CharSet = &quot;UTF-8&quot;;  即可，再发邮件就正常了，不会归到垃圾邮件了</p>
<p><img src="../../../images/blog/web/web_php_mail_3.png" alt="image"></p>

          </article>
          <aside>
            <div>
              <ul><li><span class="ul-span" data-id="php发送邮件" style="padding-left:1em">php发送邮件<span></li><ul><li><span class="ul-span" data-id="php发送邮件的两种方式" style="padding-left:2em">php发送邮件的两种方式<span></li><ul><li><span class="ul-span" data-id="直接使用系统的mail函数需要本地邮件服务器" style="padding-left:3em">直接使用系统的mail()函数(需要本地邮件服务器)<span></li></ul><ul><li><span class="ul-span" data-id="使用phpmailer可使用qq发邮件" style="padding-left:3em">使用PHPMailer(可使用qq发邮件)<span></li><ul><li><span class="ul-span" data-id="在项目中引入composer" style="padding-left:4em">在项目中引入composer<span></li></ul><ul><li><span class="ul-span" data-id="开始发送邮件" style="padding-left:4em">开始发送邮件<span></li></ul></ul></ul><ul><li><span class="ul-span" data-id="发送邮件遇到的问题" style="padding-left:2em">发送邮件遇到的问题<span></li></ul></ul>
            <div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2020 zuo11.com. 鄂ICP备16014741号-1</div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script>
          let asideDiv = document.getElementsByTagName('aside')[0]
          asideDiv.onclick = (e) => {
            let id = e.target.dataset.id
            if (!id) return
            // 移除所有的active
            let nodes = document.getElementsByClassName('ul-span')
            for (let i = 0, len = nodes.length; i < len; i++) {
              nodes[i].classList.remove('active')
            }
            e.target.classList.add('active')
            document.getElementById(id).scrollIntoView(true)
            document.documentElement.scrollBy(0, -70)
          }

          let headersArr = []

          // 通过category.html#web进入页面时, 由于顶部fixed会有遮挡，fix方案
          window.onload = () => {
            // 如果是category，且有hash值，向上滚动 -70
            let { pathname, hash } = location
            pathname.includes('category.html') && hash && document.documentElement.scrollBy(0, -70)

            // 将每个标题的高度，存到数组里，当滚动时，自动focus右侧大纲
            let nodes = document.getElementsByClassName('ul-span')
            for (let i = 0, len = nodes.length; i < len; i++) {
              // console.log(nodes.dataset)
              let id = nodes[i].dataset.id
              headersArr.push({id: id, offsetTop: document.getElementById(id).offsetTop})
            }
            // console.log(headersArr)

            window.onscroll = () => {
              focusAsideSpan()
              // debounce(focusAsideSpan)
            }
          }

          // 效果不好，没有实时滚动的感觉，关闭防抖
          // function debounce(method, context) {
          //   clearTimeout(method.tId)
          //   method.tId = setTimeout(function() {
          //     method.call(context)
          //   }, 100)
          // }
          
          function focusAsideSpan() {
            let scrollTop = document.documentElement.scrollTop
            let curNode
            for (let i = 0, len = headersArr.length; i < len; i++) {
              if (headersArr[i].offsetTop - scrollTop >= 0) {
                // 移除所有的active
                let nodes = document.getElementsByClassName('ul-span')
                for (let j = 0, len = nodes.length; j < len; j++) {
                  if (headersArr[i].id === nodes[j].dataset.id) {
                    nodes[j].classList.remove('active')
                    nodes[j].classList.add('active')
                  } else {
                    nodes[j].classList.remove('active')
                  }
                }
                return
              }
            }
            // 如果走到这里，说明滚到底部了
            // 移除所有的active
            let nodes = document.getElementsByClassName('ul-span')
            for (let i = 0, len = nodes.length; i < len; i++) {
              nodes[i].classList.remove('active')
            }
            nodes[nodes.length - 1].classList.add('active')
          }


          function gotoIndex() {
            window.location.href = "/"
          }

          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    

        </script>
      </body>
    </html>
  