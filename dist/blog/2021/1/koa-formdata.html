
    <!DOCTYPE html>
    <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="koa-formdata.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="一般在 koa 中，post 请求的数据是需要中间件来处理的，koa-bodyparser 可以很好的处理 json、serializer 数据，但 `multipart/form-data` 的类型无法处理，一般需要引入另外的中间件来处理，一般建议使用 multer 中间件来处理。先来看看前端上传文件代码，这里使用的是 fetch，当然也可以使用 xhr">
        <meta name="keywords" content="multipart/form-data,FormData,文件上传">

        <title>koa 使用 multer 处理文件上传，FormData 数据解析 - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
        
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#前端工程化" class="hidden">前端工程化</a>
          </div>
          <div>
            
          <a href="http://fe.zuo11.com" target="_black" class="hidden">我的笔记</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            <h1 id="koa-使用-multer-处理文件上传，formdata-数据解析">koa 使用 multer 处理文件上传，FormData 数据解析</h1>
            
    <div class="article-top">
      <div class="flex">
        这篇文章发布于 2021/01/12，归类于 <a href="/blog/category.html#前端工程化" class="hidden">前端工程化</a>
        <!-- ，阅读 11 次，今日 1 次 <div class="top-comment">4 条评论</div> -->
        <div id="readAndComment" class="flex"></div>
      </div> 
      <div class="flex keywords" style="flex-wrap: nowrap;">
        <div style="flex-shrink:0; align-self: flex-start;">标签：</div>
        <div class="flex" style="flex-wrap: wrap;"><span>multipart/form-data</span>，<span>FormData</span>，<span>文件上传</span></div>
      </div>
    </div>
    
  
            
<p>一般在 koa 中，post 请求的数据是需要中间件来处理的，koa-bodyparser 可以很好的处理 json、serializer 数据，但 <code>multipart/form-data</code> 的类型无法处理，一般需要引入另外的中间件来处理，一般建议使用 multer 中间件来处理。先来看看前端上传文件代码，这里使用的是 fetch，当然也可以使用 xhr</p>
<pre><code class="language-html">&lt;!-- &lt;input type=&quot;file&quot; id=&quot;file&quot;&gt; --&gt;
&lt;input type=&quot;file&quot; id=&quot;file&quot; multiple&gt;
&lt;script&gt;
  let fileInput = document.getElementById(&#39;file&#39;)

  fileInput.onchange = (event) =&gt; {
    let formData = new FormData()
    // 多个文件上传：使用同一个字段上传
    console.log(event.target.files) // FileList 类数组对象
    let files = event.target.files
    for (let i = 0, len = files.length; i &lt; len; i++) {
      formData.append(&#39;image&#39;, files[i])
    }
    // 单文件上传
    // formData.append(&#39;image&#39;, files[0])
    formData.append(&#39;param1&#39;, &#39;abc&#39;)
    fetch(&#39;/upload&#39;, {
      method: &#39;POST&#39;,
      body: formData
    })
    .then(console.log)
    .catch(console.log)
    //  { param1: &#39;abc&#39; }
  }
&lt;/script&gt;</code></pre>
<p>可以看到在前端需要上传文件时，一般使用 FormData 类型数据。使用一个字段存放文件数据，上面例子中使用的是 &quot;image&quot; 字段。另外在上传文件时，额外添加了一个 param1 字段数据。下面来看看 multer 中间件是如何处理文件上传的，注意以下几点:</p>
<ul>
<li>如果是单文件上传，使用 <code>multer().single(&#39;文件字段&#39;)</code>。ctx.file 可以拿到 file 对象</li>
<li>如果是多文件上传，使用 <code>multer().fields([{ name: &#39;文件字段&#39;, maxCount: &#39;允许最大数&#39;}])</code>。ctx.files 可以拿到文件数据对象 <code>{ 字段1: [ file 数组], 字段2: [file 数组] }</code></li>
<li>如果非文件上传，仅接收 FormData 类型的文本字段，使用 <code>multer().none()</code></li>
<li>普通 FormData 字段可以从 ctx.request.body 中获取</li>
<li>file 对象包含如下属性<ul>
<li><code>fieldname</code> 前端用于存放文件的字段名，这里例子中使用的是 &#39;image&#39;</li>
<li><code>originalname</code> 文件名</li>
<li><code>mimetype</code> 文件 MIMT 类型</li>
<li><code>buffer</code> 文件二进制数据，可以直接使用 <code>fs.writeFileSync(文件名, buffer)</code> 创建文件</li>
<li><code>size</code> 文件大小，单位字节</li>
</ul>
</li>
</ul>
<pre><code class="language-js">const multer = require(&#39;@koa/multer&#39;)
const fs = require(&#39;fs&#39;)

// 文件上传处理
// 前端 append 文件时使用的是 image 字段
let singleFileConfig = multer().single(&#39;image&#39;)
let multipleFilesConfig = multer().fields([
  {
    name: &#39;image&#39;,
    maxCount: 5
  }
])
let isMultiple = true
let fileConfig = isMultiple ? multipleFilesConfig : singleFileConfig
router.post(&#39;/upload&#39;, fileConfig ,async ctx =&gt; {

  // 文件外的其他 FormData数据 { param1: &#39;abc&#39; }
  console.log(&#39;ctx.request.body&#39;, ctx.request.body) 
  console.log(&#39;ctx.files&#39;, ctx.files) // 多文件，返回 { 字段1: [file数组], 字段2: [file数组] }
  console.log(&#39;ctx.file&#39;, ctx.file) // 单文件，返回 file 对象

  // 如果是单文件取文件内容，如果是多文件，取第一个文件，前端字段传的 image
  let file = isMultiple ? ctx.files[&#39;image&#39;][0] : ctx.file
  isMultiple &amp;&amp; console.log(`ctx.files[&#39;image&#39;]`, ctx.files[&#39;image&#39;][0])

  // 在服务端本地创建文件
  let { originalname, buffer } = file
  fs.writeFileSync(originalname, buffer)
  // {
  //   fieldname: &#39;image&#39;,
  //   originalname: &#39;截屏2020-12-10 下午8.01.44.png&#39;,
  //   encoding: &#39;7bit&#39;, 
  //   mimetype: &#39;image/png&#39;,
  //   buffer: &lt;Buffer 89 50 4e 47 0d 0a 1a 0a 00 00 00 0d 49 48 44 52 00 00 03 18 00 00 01 56 08 06 00 00 00 ea b0 3b 51 00 00 0c 64 69 43 43 50 49 43 43 20 50 72 6f 66 69 ... 90135 more bytes&gt;,
  //   size: 90185
  // }
  ctx.body = ctx.request.body 
})</code></pre>
<p>完整测试代码，参见 <a href="https://github.com/zuoxiaobai/fedemo/tree/master/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/fetch">fetch 上传文件 前端后代码 | Github</a></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/expressjs/multer">express/multer &#39;multipart/form-data&#39; | Github</a></li>
<li><a href="https://github.com/koajs/multer">@koa/multer | Github</a></li>
</ul>

            
            <ins class='adsbygoogle' style='display:block;margin-top:1em;margin-bottom:0' data-ad-format='fluid' data-ad-layout-key='-gw-3+1f-3d+2z' data-ad-client='ca-pub-9527676606416641' data-ad-slot='8870245163'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            <!-- 评论系统占位 -->
            <div id="commentDiv"></div>
          </article>

          <aside>
            <div class="aside-wrap">
              <div class="top ">
                <ul><li><span class="ul-span" data-id="koa-使用-multer-处理文件上传，formdata-数据解析" style="padding-left:1em">koa 使用 multer 处理文件上传，FormData 数据解析<span></li></ul>
              </div>
              <ins class='adsbygoogle' style='display:block;width:300px;height:250px;' data-ad-client='ca-pub-9527676606416641' data-ad-slot='9476232907'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2021 zuo11.com. <a href='http://beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-178732583-1"></script> -->
<script>
  // window.dataLayer = window.dataLayer || [];
  // function gtag(){dataLayer.push(arguments);}
  // gtag('js', new Date());
  // gtag('config', 'UA-178732583-1');

  window.onload = function() {
    setTimeout(function() {
      let script = document.createElement("script");
      script.setAttribute("data-ad-client", "ca-pub-9527676606416641");
      script.setAttribute("async", "");
      script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
      document.body.appendChild(script);
    }, 200);
  }
</script>

      </body>
    </html>
  