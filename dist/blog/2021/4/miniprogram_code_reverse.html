
    <!DOCTYPE html>
    <html lang="zh-CN">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <meta name="application name" content="miniprogram_code_reverse.html">
        <meta name="author" content="guoqzuo">
        <meta name="description" content="小程序代码找回，小程序云开发代码找回，小程序云函数恢复，最近想把之前写的一个已上线的小程序开源，发现当时居然没有用 git 管理，换电脑、折腾 mac 双系统后，代码丢失了。尝试用数据恢复软件恢复都没有找回代码，尽管小程序的文件特征很好找，比如 .wxml、project.config.json 等。后面在网上找了反编译线上小程序的方法。这样可以拿到 uglify 混淆压缩后的代码，至少比没有强。另外，云函数的代码也是可以恢复的，因为之前开发时上传过，它是可以下载的。">
        <meta name="keywords" content="小程序代码找回,小程序云开发代码找回,小程序云函数恢复">

        <title>小程序代码找回，代码丢失后找回过程记录（反编译、云开发函数恢复） - 左小白的技术日常</title>
        <link rel="shortcut icon" href="/images/favicon.ico">
        <link href="/lib/prismjs/prism_default.css" rel="stylesheet" />
        <link href="/lib/notes.css" rel="stylesheet" />
        <link rel="stylesheet" href="/lib/global.css">
        
      </head>
      <body>
        <header>
          <div>
            <img src="/images/logo.png" width="24" height="24" class="pointer" onclick="gotoIndex()" />
            <span class="pointer" onclick="gotoIndex()">左小白的技术日常</span>
            <span class="hidden"> | </span>
            <a href="/blog/category.html#微信开发" class="hidden">微信开发</a>
          </div>
          <div>
            
          <a href="http://fe.zuo11.com" target="_black" class="hidden">我的笔记</a>
        
          <a href="https://github.com/zuoxiaobai" target="_black" class="">Github</a>
        
          </div>
        </header>
        <section class="content">
          <article>
            <h1 id="小程序代码找回，代码丢失后找回过程记录（反编译、云开发函数恢复）">小程序代码找回，代码丢失后找回过程记录（反编译、云开发函数恢复）</h1>
            
    <div class="article-top">
      <div class="flex">
        这篇文章发布于 2021/04/11，归类于 <a href="/blog/category.html#微信开发" class="hidden">微信开发</a>
        <!-- ，阅读 11 次，今日 1 次 <div class="top-comment">4 条评论</div> -->
        <div id="readAndComment" class="flex"></div>
      </div> 
      <div class="flex keywords" style="flex-wrap: nowrap;">
        <div style="flex-shrink:0; align-self: flex-start;">标签：</div>
        <div class="flex" style="flex-wrap: wrap;"><span>小程序代码找回</span>，<span>小程序云开发代码找回</span>，<span>小程序云函数恢复</span></div>
      </div>
    </div>
    
  
            
<p>最近想把之前写的一个已上线的小程序开源，发现当时居然没有用 git 管理，换电脑、折腾 mac 双系统后，代码丢失了。尝试用数据恢复软件恢复都没有找回代码，尽管小程序的文件特征很好找，比如 .wxml、project.config.json 等。</p>
<p>后面在网上找了反编译线上小程序的方法。这样可以拿到 uglify 混淆压缩后的代码，至少比没有强。另外，云函数的代码也是可以恢复的，因为之前开发时上传过，它是可以下载的。</p>
<blockquote>
<p>注意：反编译小程序要求必须是已上线的小程序。对于云函数的恢复/下载，需要知道之前开发的 appid，且微信账号拥有对应的管理员/开发权限。</p>
</blockquote>
<h2 id="为什么小程序可以反编译？">为什么小程序可以反编译？</h2>
<p>理论上小程序也是属于前端代码，前端的 js、css、html 一般是可以拿到的。微信在打开小程序时，会先下载对应小程序的包(.wxapkg文件)来执行。只要我们拿到这个文件，就可以通过反编译拿到混淆压缩后的代码。这里反编译使用的是 <a href="https://github.com/qwerty472123/wxappUnpacker">wxappUnpacker</a>，虽然删除了，但点开 fork，有很多之前备份的代码。 </p>
<h2 id="获取小程序的-wxapkg-文件">获取小程序的 wxapkg 文件</h2>
<ol>
<li>下载安装 <a href="https://www.yeshen.com/">夜神模拟器</a>，注意：如果是 mac 系统，打开后一直卡在 99%，可能是因为 VirtualBox 的原因，安装该模拟器时，会自动安装 VirtualBox，可以在 app 中手动打开 VirtualBox 并启动，再打开模拟器。</li>
<li>下载 <a href="http://www.pc6.com/az/56118.html">RE 文件管理器</a>，文件名为：com.speedsoftware.rootexplorer_999496.apk</li>
<li>在 模拟器中 安装 RE文件管理器，点击模拟器右侧的 添加 apk 文件图标，选择刚才下好的 apk 文件进行安装。如下图，安装完成后打开该 app，并允许获取权限。</li>
</ol>
<p><img src="../../../images/blog/mp/wxapkg_1_1.png" alt="wxapkg_1_1.png"></p>
<ol start="4">
<li>在模拟器中搜索 微信，安装好后，运行微信，登录后，打开对应的小程序</li>
<li>打开小程序后，在文件管理器的 <code>/data/data/com.tencent.mm/MicroMsg/{数字串}/appbrand/pkg/</code> 目录，可以看到对应的 .wxapkg 文件，如下图。注意：如果找不到对应的文件，可以点击右上角的三个点，搜索对应的文件。</li>
</ol>
<p><img src="../../../images/blog/mp/wxapkg_1_2.png" alt="wxapkg_1_2.png"></p>
<ol start="6">
<li>导出 .wxapkg 文件。鼠标长按对应的文件，多选两个 wxapkg 文件，点击右上角三个点，zip 压缩，压缩后，查看对应的文件，再点击右上角三个点，发送到微信即可。 </li>
</ol>
<p><img src="../../../images/blog/mp/wxapkg_1_3.png" alt="wxapkg_1_3.png"></p>
<h2 id="使用-wxappunpacker-反编译-wxapkg-文件">使用 wxappUnpacker 反编译 wxapkg 文件</h2>
<p>拿到小程序的 wxapkg 文件后，我们将之前在 fork 仓库中下载好的 wxappUnpacker 在 vscode 中打开，使用 Terminal cd（进入）到对应的目录。运行 npm install 或 yarn add 安装对应的依赖。安装完成后，在当前目录下，运行 <code>node wuWxapkg.js 对应的小程序wxapkg文件</code> 命令，就可以得到反编译后的代码。</p>
<pre><code class="language-bash"># 安装依赖
npm install css-tree cssbeautify escodegen esprima js-beautify uglify-es vm2
# 还原小程序代码示例
node wuWxapkg.js &#39;/Users/zuo/Desktop/test1234/_626200936_1.wxapkg&#39;</code></pre>
<p>运行后，虽然生成了代码，但是 terminal 出现了下面的错误，css 文件未被还原</p>
<pre><code class="language-js">/wxappUnpacker-master/node_modules/vm2/lib/main.js:890
                                throw this._internal.Decontextify.value(e);
                                ^
ReferenceError [Error]: __vd_version_info__ is not defined</code></pre>
<p>这里需要修改 wxappUnpacker 项目中 wuWxss.js 中的 runOnce() 函数代码</p>
<pre><code class="language-js">// wuWxss.js
// function runOnce(){
//     for(let name in runList)runVM(name,runList[name]);
// }
function runOnce() {
  for (let name in runList) {
    // console.log(name, runList[name]);
    var start = `var window = window || {}; var __pageFrameStartTime__ = Date.now(); var __webviewId__; var __wxAppCode__={}; var __mainPageFrameReady__ = function(){}; var __WXML_GLOBAL__={entrys:{},defines:{},modules:{},ops:[],wxs_nf_init:undefined,total_ops:0}; var __vd_version_info__=__vd_version_info__||{};

    $gwx=function(path,global){

    if(typeof global === &#39;undefined&#39;) global={};if(typeof __WXML_GLOBAL__ === &#39;undefined&#39;) {__WXML_GLOBAL__={};

    }__WXML_GLOBAL__.modules = __WXML_GLOBAL__.modules || {};

    }`;
    runVM(name, start + &quot; \r\n&quot; + runList[name]);
  }
}</code></pre>
<p>修改后再次执行就 OK 了，代码大致就恢复了。目录结构如下</p>
<p><img src="../../../images/blog/mp/wxapkg_2_1.png" alt="wxapkg_2_1.png"></p>
<h2 id="小程序云开发，云函数代码恢复">小程序云开发，云函数代码恢复</h2>
<blockquote>
<p>理论上云开发和小程序 appid，微信号开发权限是相关联的，如果没有权限是无法还原云函数的</p>
</blockquote>
<p>这个项目是小程序云开发的项目，而 wxappUnpacker 恢复的只是普通小程序的目录结构。下面是小程序云开发的目录结构</p>
<p><img src="../../../images/blog/mp/wxapkg_2_2.png" alt="wxapkg_2_2.png"></p>
<p>我们需要进一步处理</p>
<ol>
<li>创建一个新的文件夹，比如 my-app，然后在目录下创建 cloudfunctions 和 miniprogram 文件夹，将恢复的代码，拷贝到 miniprogram 中</li>
<li>创建 project.config.json 文件，找到之前开发该小程序时，使用的该小程序的 appid，修改 project.config.json 文件</li>
</ol>
<pre><code class="language-js">{
  &quot;miniprogramRoot&quot;: &quot;miniprogram/&quot;,
  &quot;cloudfunctionRoot&quot;: &quot;cloudfunctions/&quot;,
  &quot;appid&quot;: &quot;wx45333c9fc02af773&quot;,
  &quot;projectname&quot;: &quot;my-app&quot;
}</code></pre>
<ol start="3">
<li>打开微信小程序开发工具，选择导入项目，选择 my-app 目录，即可打开项目，如下图</li>
</ol>
<p><img src="../../../images/blog/mp/wxapkg_3_1.png" alt="wxapkg_3_1.png"></p>
<p>由于我们之前创建过云开发环境，因此我们右键 cloudfunctions 目录，可以选择当前环境比如 test。这时 cloudfunctions 是空的，可以右键后，选择同步云函数列表</p>
<p><img src="../../../images/blog/mp/wxapkg_3_2.png" alt="wxapkg_3_2.png"></p>
<p>同步后，cloudfunctions 目录下就会创建之前的云函数文件夹，如下图，右键对应的云函数文件夹，选择下载，即可下载对应云函数的代码。</p>
<p><img src="../../../images/blog/mp/wxapkg_3_3.png" alt="wxapkg_3_3.png"></p>
<p>云函数代码，不是混淆压缩的，是 100% 还原的，如下图</p>
<p><img src="../../../images/blog/mp/wxapkg_3_4.png" alt="wxapkg_3_4.png"></p>
<p>自此，项目就大致还原了。美中不足的是，样式没有恢复完全，另外 js 都是混淆压缩后的代码，需要慢慢修改还原。</p>
<p>不过项目还是可以跑起来的，比完全丢失了好，还原后的该小程序已开源，后面会慢慢修复还原混淆压缩后的代码。开源地址：<a href="https://github.com/ibdlib/remicade-record">remicade-record - github</a></p>
<p>参考: </p>
<ul>
<li><a href="https://blog.csdn.net/qq_38822390/article/details/82152004">小程序源码丢失了怎么在微信平台反编译找回</a></li>
<li><a href="https://www.jianshu.com/p/83b9e7d3ded4">最新解决小程序反编译$gwx is not defined和<strong>vd_version_info</strong> is not defined</a></li>
<li><a href="https://www.cnblogs.com/yeahwell/p/13546770.html">2020微信小程序反编译（逆向），仅用于学习请勿商用</a></li>
</ul>

            
            <ins class='adsbygoogle' style='display:block;margin-top:1em;margin-bottom:0' data-ad-format='fluid' data-ad-layout-key='-gw-3+1f-3d+2z' data-ad-client='ca-pub-9527676606416641' data-ad-slot='8870245163'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            <!-- 评论系统占位 -->
            <div id="commentDiv"></div>
          </article>

          <aside>
            <div class="aside-wrap">
              <div class="top ">
                <ul><li><span class="ul-span" data-id="小程序代码找回，代码丢失后找回过程记录（反编译、云开发函数恢复）" style="padding-left:1em">小程序代码找回，代码丢失后找回过程记录（反编译、云开发函数恢复）<span></li><ul><li><span class="ul-span" data-id="为什么小程序可以反编译？" style="padding-left:2em">为什么小程序可以反编译？<span></li></ul><ul><li><span class="ul-span" data-id="获取小程序的-wxapkg-文件" style="padding-left:2em">获取小程序的 wxapkg 文件<span></li></ul><ul><li><span class="ul-span" data-id="使用-wxappunpacker-反编译-wxapkg-文件" style="padding-left:2em">使用 wxappUnpacker 反编译 wxapkg 文件<span></li></ul><ul><li><span class="ul-span" data-id="小程序云开发，云函数代码恢复" style="padding-left:2em">小程序云开发，云函数代码恢复<span></li></ul></ul>
              </div>
              <ins class='adsbygoogle' style='display:block;width:300px;height:250px;' data-ad-client='ca-pub-9527676606416641' data-ad-slot='9476232907'></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
          </aside>
        </section>
        <footer>
          <div class="footer_content">
            <div class="footer_right">Copyright © 2016-2021 zuo11.com. <a href='http://beian.miit.gov.cn/'>鄂ICP备16014741号-1</a></div>
            <div>Powered by <a href='https://github.com/zuoxiaobai/zuo-blog' target='_black'>zuo-blog</a></div>
          </div>
        </footer>
        <script src="/lib/prismjs/prism_default.js"></script>
        <script src="/lib/notes.js"></script> 
        <script src="/lib/global.js"></script>
        <script>
          
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?183281668cc3440449274d1f93c04de6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-178732583-1"></script> -->
<script>
  // window.dataLayer = window.dataLayer || [];
  // function gtag(){dataLayer.push(arguments);}
  // gtag('js', new Date());
  // gtag('config', 'UA-178732583-1');

  window.onload = function() {
    setTimeout(function() {
      let script = document.createElement("script");
      script.setAttribute("data-ad-client", "ca-pub-9527676606416641");
      script.setAttribute("async", "");
      script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
      document.body.appendChild(script);
    }, 200);
  }
</script>

      </body>
    </html>
  